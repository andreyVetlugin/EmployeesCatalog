<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Сотрудники с профилями</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.0/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="form-group col-md-5">
    <ul class="list-group list-group-horizontal">
        <li style="border: none;" class="list-group-item"> <a href="EmployeeEditor.html"> Сотрудники </a></li>
        <li style="border: none;" class="list-group-item"> <a href="ProfileEditor.html">  Профили</a></li>
    </ul>
        <h2>Профили:</h2>
        <div id="errors" class="alert alert-danger" style="display:none;"></div>
        <form name="Profile">
            <input type="hidden" name="id" value="-1" />
            <div>
                <label for="fullName">Полное имя:</label>
                <input class="form-control" name="fullName" />
            </div>
            <div>
                <label for="email">Email:</label>
                <input class="form-control" name="email" type="email" />
            </div>
            <div>
                <label for="birthDate">Дата рождения:</label>
                <input class="form-control" name="birthDate" type="date" />
            </div>
            <div>
                <label for="phoneNumber">Номер телефона:</label>
                <input class="form-control" name="phoneNumber" type="tel" />
            </div>
        </form>
        <form name="addEmployeeForm">
            <ul class="list-group list-group-horizontal">
                <li style="border: none;" class="list-group-item"><button onclick="StartCreatingEmployee()" type="button" class="btn btn-primary"> Создать должность</button></li>
                <li style="border: none;" class="list-group-item"> или выбрать должность</li>
                <li style="border: none;" class="list-group-item">
                    <select id="EmployeesSelector" onchange="StartEditingEmployee()" class="form-control">
                        <option id="0">Выберите должность</option>
                    </select>
                </li>
            </ul>
        </form>
        <form name="Employee" style="display:none">
            <input type="hidden" name="id" value="-1" />
            <div>
                <label for="position">Должность:</label>
                <input class="form-control" name="position" />
            </div>
            <div>
                <label for="subdivision">Подразделение:</label>
                <input class="form-control" name="subdivision" type="text" />
            </div>
            <div>
                <label for="salary">Оклад:</label>
                <input class="form-control" name="salary" type="number" />
            </div>
            <button style="margin-bottom:20px" type="button" id="unattach" onclick="UnattachEmployee()" class="btn btn-primary">Открепить должность</button>
        </form>

        <div class="panel-body">
            <button type="button" id="submitButton" class="btn btn-primary">Добавить</button>
            <button type="button" id="resetButton" class="btn btn-primary">Сбросить</button>
        </div>
        <table class="table table-condensed table-striped ">
            <thead><tr><th style="display:none;">Id</th><th>Полное имя</th><th style="display:none;">Id</th><th>Должность</th></tr></thead>
            <tbody>
            </tbody>
        </table>
        <nav aria-label="Page navigation ">
            <ul class="pagination" id="pagination">
            </ul>
        </nav>
        <script>

            LoadEmployees();

            function StartCreatingEmployee() {
                let form = document.forms["Employee"];
                form.setAttribute("style", "display:block;");
                form.elements["id"].innerHTML = -1;
                document.forms["addEmployeeForm"].setAttribute("style", "display:none");
            }

            async function StartEditingEmployee() {

                const selectedValue = GetSelectedOption(document.getElementById("EmployeesSelector"));
                let form = document.forms["Employee"];
                if (selectedValue.id == 0)
                    return;
                form.setAttribute("style", "display:block;");
                const response = await fetch("Employees/" + selectedValue.id, {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });
                if (response.ok === true) {
                    const employee = await response.json();
                    const form = document.forms["Employee"];
                    form.elements["id"].value = employee.id;
                    form.elements["position"].value = employee.position;
                    form.elements["subdivision"].value = employee.subdivision;
                    form.elements["salary"].value = employee.salary;
                    document.forms["addEmployeeForm"].setAttribute("style", "display:none");
                } else {
                    HandleRequestErrors(response.json);
                }
            }

            async function LoadEmployees() {
                const response = await fetch("EmployeesProfiles/freeEmployees", {
                    method: "GET",
                    headers: { "Accept": "application/json", "Content-Type": "application/json" },
                });
                const employeesSelector = document.getElementById("EmployeesSelector");

                const list = await response.json();
                list.forEach(employee => {
                    const option = document.createElement("option");
                    option.text = employee.position;
                    option.id = employee.id;
                    employeesSelector.add(option);
                });
            }

            async function GetProfilesWithEployees(startItem, itemsCount) {
                const response = await fetch("EmployeesProfiles?startIndex=" + startItem + "&itemsCount=" + itemsCount, {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });
                if (response.ok === true) {
                    const profiles = await response.json();
                    let rows = document.querySelector("tbody");

                    rows.innerHTML = "";

                    profiles.items.forEach(e => {
                        rows.append(CreateRow(e));
                    });

                    ConfigurePagination(4, startItem, profiles.itemsCount);
                }
                else {
                    HandleRequestErrors(response.json)
                }
            }

            async function GetProfileWithEmployee(id) {
                const response = await fetch("EmployeesProfiles/" + id, {
                    method: "GET",
                    headers: { "Accept": "application/json" }
                });
                if (response.ok === true) {
                    const responseData = await response.json();
                    const profile = responseData.profile;
                    const employee = responseData.employee;

                    const profileForm = document.forms["Profile"];
                    profileForm.elements["id"].value = profile.id;
                    profileForm.elements["fullName"].value = profile.fullName;
                    profileForm.elements["email"].value = profile.email;
                    profileForm.elements["birthDate"].value = GetFormDate(new Date(profile.birthdate));
                    profileForm.elements["phoneNumber"].value = profile.phoneNumber;
                    if (employee != undefined) {
                        const employeeForm = document.forms["Employee"];
                        employeeForm.setAttribute("style", "display:block");
                        employeeForm.elements["id"].value = employee.id;
                        employeeForm.elements["position"].value = employee.position;
                        employeeForm.elements["subdivision"].value = employee.subdivision;
                        employeeForm.elements["salary"].value = employee.salary;
                        document.forms["addEmployeeForm"].setAttribute("style", "display:none");
                    }

                } else {
                    HandleRequestErrors(response.json)
                }
            }

            async function CreateProfileWithEmployee(profile, employee) {
                ResetErrors();
                const response = await fetch("EmployeesProfiles", {
                    method: "POST",
                    headers: { "Accept": "application/json", "Content-Type": "application/json" },
                    body: JSON.stringify({
                        Profile: {
                            fullName: profile.fullName,
                            email: profile.email,
                            birthDate: profile.birthDate,
                            phoneNumber: profile.phoneNumber
                        },
                        Employee: employee
                    })
                });

                if (response.ok === true) {
                    location.reload();
                }
                else {
                    const errorData = await response.json();
                    HandleRequestErrors(errorData);
                }
            }

            async function EditProfileWithEmployee(profile, employee) {
                ResetErrors();

                const response = await fetch("EmployeesProfiles",
                    {
                        method: "PUT",
                        headers: { "Accept": "application/json", "Content-Type": "application/json" },
                        body: JSON.stringify({
                            Profile: profile,
                            Employee: employee
                        })
                    });

                if (response.ok === true) {
                    location.reload();
                } else {
                    const errorData = await response.json();
                    HandleRequestErrors(errorData);
                }
            }

            async function DeleteProfileWithEmployee(id) {
                ResetErrors();
                const response = await fetch("Profiles/" + id, {
                    method: "DELETE",
                    headers: { "Accept": "application/json" }
                });
                if (response.ok === true) {
                    location.reload();
                }
                else {
                    const errorData = await response.json();
                    HandleRequestErrors(errorData);
                }
            }

            function ConfigurePagination(itemsPerPage, startItem, itemsCount) {


                const viewDistance = 2;
                let pageCount = Math.ceil(itemsCount / itemsPerPage);
                let currentPage = Math.ceil(startItem / itemsPerPage) + 1;
                let paginationForm = document.getElementById("pagination");
                while (paginationForm.firstChild) {
                    paginationForm.removeChild(paginationForm.firstChild);
                }
                let leftPageNumber = currentPage - viewDistance;
                let rightPageNumber = currentPage + viewDistance;
                if (leftPageNumber <= 0)
                    leftPageNumber = 1;
                if (rightPageNumber > pageCount)
                    rightPageNumber = pageCount;
                for (let i = leftPageNumber; i <= rightPageNumber; i++) {
                    let liElement = document.createElement("li");
                    liElement.setAttribute("class", "page-item");
                    linkElement = document.createElement("a");
                    linkElement.text = i;
                    linkElement.setAttribute("class", "page-link");
                    if (i != currentPage)
                        linkElement.setAttribute("href", "");
                    linkElement.addEventListener("click", e => {
                        e.preventDefault();
                        GetProfilesWithEployees((i - 1) * itemsPerPage, itemsPerPage);
                    });
                    liElement.appendChild(linkElement);
                    paginationForm.appendChild(liElement);
                }

            }

            function Reset() {
                const form = document.forms["Profile"];
                form.reset();
                form.elements["id"].value = -1;
                UnattachEmployee();
            }

            function UnattachEmployee() {
                const employeeForm = document.forms["Employee"];
                employeeForm.reset();
                employeeForm.elements["id"].value = -1;
                employeeForm.setAttribute("style", "display:none");
                document.forms["addEmployeeForm"].setAttribute("style", "display:block");
            }

            function HandleRequestErrors(errors) {

                if (errors.hasOwnProperty("errors")) {
                    for (prop in errors["errors"])
                        for (error of errors["errors"][prop])
                            AddError(error);
                }
                else {
                    AddError(errors)
                }
                document.getElementById("errors").style.display = "block";
            }

            function AddError(error) {
                const p = document.createElement("p");
                p.append(error);
                document.getElementById("errors").append(p);
            }

            function ResetErrors() {
                document.getElementById("errors").innerHTML = "";
                document.getElementById("errors").style.display = "none";
            }

            function GetFormDate(date) {
                var d = new Date(date.getFullYear(), date.getMonth(), date.getDate());

                return ("0000" +
                    d.getFullYear()).slice(-4) +
                    "-" +
                    ("00" + (date.getMonth() + 1)).slice(-2) +
                    "-" +
                    ("00" + date.getDate()).slice(-2);

            }

            function CreateRow(profileEmployee) {
                let profile = profileEmployee.profile;
                let employee = profileEmployee.employee;

                const tr = document.createElement("tr");
                tr.setAttribute("data-rowid", profile.Id);

                const idTd = document.createElement("td");
                idTd.append(profile.id);
                idTd.style.display = "none";
                tr.append(idTd);

                const fullNameId = document.createElement("td");
                fullNameId.append(profile.fullName);
                tr.append(fullNameId);

                if (employee != null) {

                    const employeeIdTd = document.createElement("td");
                    employeeIdTd.append(employee.id);
                    employeeIdTd.style.display = "none";
                    tr.append(employeeIdTd);

                    const positionTd = document.createElement("td");
                    positionTd.append(employee.position);
                    tr.append(positionTd);
                } else {
                    const positionTd = document.createElement("td");
                    positionTd.append("");
                    tr.append(positionTd);
                }

                const linksTd = document.createElement("td");
                const editLink = document.createElement("a");

                editLink.setAttribute("data-id", profile.id);
                editLink.setAttribute("style", "cursor:pointer;padding:15px;");
                editLink.append("Изменить");
                editLink.addEventListener("click", e => {
                    e.preventDefault();
                    GetProfileWithEmployee(profile.id);
                });
                linksTd.append(editLink);

                const removeLink = document.createElement("a");
                removeLink.setAttribute("data-id", profile.id);
                removeLink.setAttribute("style", "cursor:pointer;padding:15px;");
                removeLink.append("Удалить");
                removeLink.addEventListener("click", e => {
                    e.preventDefault();
                    if (!confirm("Удалить запись?"))
                        return;
                    DeleteProfileWithEmployee(profile.id);
                });

                linksTd.append(removeLink);
                tr.appendChild(linksTd);
                return tr;
            }

            function GetSelectedOption(sel) {
                var opt;
                for (var i = 0, len = sel.options.length; i < len; i++) {
                    opt = sel.options[i];
                    if (opt.selected === true) {
                        break;
                    }
                }
                return opt;
            }

            document.getElementById("resetButton").addEventListener("click", e => {
                Reset();
            });

            document.getElementById("submitButton").addEventListener("click", e => {
                const form = document.forms["Profile"];
                let profile = {};
                profile.id = form.elements["id"].value;
                profile.fullName = form.elements["fullName"].value;
                profile.birthDate = form.elements["birthDate"].value;
                profile.email = form.elements["email"].value;
                profile.phoneNumber = form.elements["phoneNumber"].value;

                const employeeForm = document.forms["Employee"];

                let employee;
                if (!employeeForm.getAttribute("style").includes("display:none")) {
                    employee = {};
                    employee.id = employeeForm.elements["id"].value != -1 ? employeeForm.elements["id"].value : null;
                    employee.position = employeeForm.elements["position"].value;
                    employee.subdivision = employeeForm.elements["subdivision"].value;
                    employee.salary = Number(employeeForm.elements["salary"].value);
                }

                if (profile.id == -1)
                    CreateProfileWithEmployee(profile, employee);
                else
                    EditProfileWithEmployee(profile, employee);
            });

            GetProfilesWithEployees(0, 4);

        </script>
</body>
</html>